
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // Aturan dasar: Secara default, hanya admin yang sudah login yang bisa melakukan apa pun.
    // Ini adalah fondasi keamanan kita.
    match /{document=**} {
      allow read, write: if request.auth != null;
    }

    // --- PENGECUALIAN AKSES PUBLIK (TANPA LOGIN) ---
    // Aturan di bawah ini adalah pengecualian yang aman untuk fitur-fitur
    // yang perlu diakses oleh sistem eksternal seperti bot Telegram.

    // Izinkan siapa saja membaca konfigurasi aplikasi untuk halaman login.
    match /settings/appConfig {
      allow read: if true;
    }

    // Izinkan bot Telegram membaca konfigurasinya.
    match /settings/telegramConfig {
      allow read: if true;
    }
    
    // Izinkan fitur sinkronisasi manual untuk membaca dan menulis status terakhirnya.
    match /settings/telegramState {
      allow read, write: if true;
    }

    // Izinkan bot Telegram membaca data kelas untuk validasi.
    match /classes/{classId} {
      allow read: if true;
    }
    
    // Izinkan bot Telegram membaca data siswa untuk validasi.
    match /students/{studentId} {
      allow read: if true;
      // PENTING: Hanya izinkan bot untuk MENGUBAH field `parentChatId`.
      // Ini melindungi data siswa lainnya dari perubahan yang tidak sah.
      allow update: if request.resource.data.diff(resource.data).affectedKeys().hasOnly(['parentChatId']);
    }
  }
}
