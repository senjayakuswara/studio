
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // --- ATURAN PENGECUALIAN (AKSES TANPA LOGIN) ---
    // Aturan di bawah ini adalah pengecualian yang sangat spesifik
    // untuk proses yang berjalan tanpa konteks login admin.

    // 1. Izinkan Server Action untuk MEMBACA nama kelas untuk pesan notifikasi.
    //    'get' lebih aman daripada 'read' karena tidak mengizinkan 'list' (query semua).
    match /classes/{classId} {
      allow get: if true;
      allow list, write: if request.auth != null;
    }

    // 2. Izinkan siapa saja MEMBACA (get) konfigurasi aplikasi.
    //    Ini diperlukan agar halaman Login bisa menampilkan nama dan logo aplikasi
    //    sebelum admin berhasil masuk.
    match /settings/appConfig {
      allow get: if true;
    }

    // --- ATURAN UTAMA (MENANGKAP SEMUA) ---
    // Aturan ini harus menjadi yang PALING AKHIR.
    // Ia secara otomatis memberikan akses penuh (baca & tulis) ke SEMUA koleksi
    // (students, attendance, settings, dll.) HANYA JIKA pengguna sudah login.
    // Inilah yang memberikan admin akses penuh ke semua fitur aplikasi.
    match /{document=**} {
      allow read, write: if request.auth != null;
    }
  }
}
